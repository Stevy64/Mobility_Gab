{% extends 'core/dashboard/base.html' %}

{% block dashboard_title %}Bonjour {{ user.first_name|default:user.email }}{% endblock %}
{% block dashboard_subtitle %}Vos abonnés, trajets et performances.{% endblock %}

{% block dashboard_actions %}
<div class="btn-group">
    <a href="/subscriptions/chauffeur_ride_requests_realtime/" class="btn btn-primary position-relative">
        <i class="bi bi-bell"></i>
        <span class="btn-text-full">Demandes temps réel</span>
        <span class="btn-text-short" style="display: none;">Demandes</span>
        <span id="pending-badge" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" style="display: none;">
            0
        </span>
    </a>
    <a href="{% url 'subscriptions:trip_history' %}" class="btn btn-outline-secondary">
        <i class="bi bi-clock-history"></i>
        <span class="btn-text-full">Historique</span>
        <span class="btn-text-short" style="display: none;">Hist.</span>
    </a>
    <a href="#" class="btn btn-danger" onclick="triggerSOS()">
        <i class="bi bi-shield-exclamation"></i>
        <span>SOS</span>
    </a>
</div>
{% endblock %}

{% block dashboard_content %}
<div class="row g-4">
    <div class="col-md-4">
        <div class="card card-kpi shadow-sm border-0 p-3 h-100">
            <div class="d-flex align-items-center">
                <div class="bg-primary bg-opacity-10 text-primary rounded-circle p-3">
                    <i class="bi bi-people fs-4"></i>
                </div>
                <div class="ms-3">
                    <p class="text-muted small mb-1">Abonnés actifs</p>
                    <h3 class="mb-0">{{ active_subscribers|default:0 }}</h3>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card card-kpi shadow-sm border-0 p-3 h-100">
            <div class="d-flex align-items-center">
                <div class="bg-success bg-opacity-10 text-success rounded-circle p-3">
                    <i class="bi bi-star fs-4"></i>
                </div>
                <div class="ms-3">
                    <p class="text-muted small mb-1">Note moyenne</p>
                    <h3 class="mb-0">{{ avg_rating|default:'--' }}</h3>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card card-kpi shadow-sm border-0 p-3 h-100">
            <div class="d-flex align-items-center">
                <div class="bg-info bg-opacity-10 text-info rounded-circle p-3">
                    <i class="bi bi-award fs-4"></i>
                </div>
                <div class="ms-3">
                    <p class="text-muted small mb-1">Badges</p>
                    <h3 class="mb-0">{{ badges_count|default:0 }}</h3>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row g-4 mt-1">
    <div class="col-lg-7">
        <div class="card shadow-sm border-0 mb-4">
            <div class="card-body">
                <h5 class="fw-bold">Trajet du jour</h5>
                <div class="rounded bg-light p-3">
                    <p class="mb-1"><strong>Abonné :</strong> {{ current_trip.parent.get_full_name|default:"Non assigné" }}</p>
                    <p class="mb-1"><strong>Adresses :</strong> {{ current_trip.pickup_location|default:'-' }} ➡ {{ current_trip.dropoff_location|default:'-' }}</p>
                    <p class="mb-2"><strong>Status :</strong> {{ current_trip.status|default:'Planifié' }}</p>
                    <div class="d-flex gap-2">
                        <button class="btn btn-outline-success btn-sm" data-checkpoint="en_route">EN ROUTE</button>
                        <button class="btn btn-outline-primary btn-sm" data-checkpoint="arrived">ARRIVÉ</button>
                        <button class="btn btn-outline-warning btn-sm" data-checkpoint="child_dropped">ENFANT DÉPOSÉ</button>
                        <button class="btn btn-outline-dark btn-sm" data-checkpoint="completed">TERMINÉ</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="card shadow-sm border-0">
            <div class="card-body">
                <h5 class="fw-bold">Historique des trajets</h5>
                <div class="table-responsive">
                    <table class="table table-sm align-middle">
                        <thead>
                            <tr class="text-muted">
                                <th>Date</th>
                                <th>Parent</th>
                                <th>Status</th>
                                <th>Note</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for trip in recent_trips %}
                            <tr>
                                <td>{{ trip.scheduled_date|date:'d/m' }}</td>
                                <td>{{ trip.parent.get_full_name|default:trip.parent.email }}</td>
                                <td><span class="badge bg-light text-dark">{{ trip.status }}</span></td>
                                <td>{{ trip.rating.score|default:'--' }}</td>
                            </tr>
                            {% empty %}
                            <tr><td colspan="4" class="text-center text-muted">Aucun trajet récent.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-5">
        <div class="card shadow-sm border-0 mb-4">
            <div class="card-body">
                <h5 class="fw-bold">Abonnés assignés</h5>
                <ul class="list-group list-group-flush small">
                    {% for subscription in assigned_subscriptions %}
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <strong>{{ subscription.parent.get_full_name|default:subscription.parent.email }}</strong>
                            <div class="text-muted">Plan: {{ subscription.plan.name }}</div>
                        </div>
                        <span class="badge bg-success rounded-pill">{{ subscription.status }}</span>
                    </li>
                    {% empty %}
                    <li class="list-group-item text-muted">Aucun abonné assigné.</li>
                    {% endfor %}
                </ul>
            </div>
        </div>
        <div class="card shadow-sm border-0">
            <div class="card-body">
                <h5 class="fw-bold">Badges</h5>
                <div class="d-flex flex-wrap gap-2">
                    {% for badge in badges %}
                    <span class="badge bg-primary bg-opacity-10 text-primary p-2"><i class="bi {{ badge.badge.icon|default:'bi-award' }}"></i> {{ badge.badge.name }}</span>
                    {% empty %}
                    <p class="text-muted small mb-0">Pas encore de badge.</p>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
{{ block.super }}
<style>
    /* Style desktop par défaut - texte complet visible */
    .dashboard-actions .btn-group .btn {
        white-space: nowrap !important;
        overflow: visible !important;
        text-overflow: clip !important;
        padding: 0.625rem 1.25rem !important;
        flex: 0 1 auto !important;
        min-width: auto !important;
    }
    
    .dashboard-actions .btn .btn-text-short {
        display: none;
    }
    
    .dashboard-actions .btn .btn-text-full {
        display: inline;
    }
    
    /* Badge de notification sur desktop */
    .dashboard-actions .btn .badge {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
    }
    
    /* Permettre au btn-group de s'adapter au contenu */
    .dashboard-actions .btn-group {
        width: auto !important;
        flex-wrap: nowrap !important;
    }
    
    /* Responsive pour mobile - boutons du trajet */
    @media (max-width: 767px) {
        /* Correction boutons dashboard actions en mode smartphone */
        .dashboard-actions .btn-group {
            display: grid !important;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 0.375rem;
            width: 100% !important;
            flex-wrap: wrap !important;
        }
        
        .dashboard-actions .btn-group .btn {
            font-size: 0.625rem !important;
            padding: 0.5rem 0.125rem !important;
            white-space: normal !important;
            word-break: break-word;
            overflow: visible !important;
            text-overflow: clip !important;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 0.125rem;
            min-height: 64px;
            line-height: 1.2;
            position: relative;
            flex: 1 1 auto !important;
        }
        
        .dashboard-actions .btn i {
            font-size: 1.125rem;
            flex-shrink: 0;
            margin-bottom: 0.125rem;
        }
        
        /* Badge de notification positionné correctement */
        .dashboard-actions .btn .badge {
            position: absolute !important;
            top: 2px !important;
            right: 2px !important;
            font-size: 0.5625rem !important;
            padding: 0.125rem 0.25rem !important;
            min-width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* S'assurer que le badge reste dans le conteneur */
        .dashboard-actions .btn.position-relative {
            overflow: visible !important;
        }
        
        /* Afficher texte court sur mobile */
        .dashboard-actions .btn .btn-text-full {
            display: none;
        }
        
        .dashboard-actions .btn .btn-text-short {
            display: inline !important;
        }
        
        .d-flex.gap-2 {
            flex-wrap: wrap;
            gap: 0.5rem !important;
        }
        
        .d-flex.gap-2 .btn-sm {
            flex: 1 1 calc(50% - 0.25rem);
            font-size: 0.75rem;
            padding: 0.5rem 0.25rem;
            white-space: normal;
            min-width: 0;
        }
        
        /* Ajuster les cards sur mobile */
        .col-lg-7, .col-lg-5 {
            width: 100%;
        }
    }
</style>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
    // Mise à jour automatique du compteur de demandes en attente
    function updatePendingRequestsCount() {
        fetch('/subscriptions/api/chauffeur/pending-count/')
            .then(response => response.json())
            .then(data => {
                const badge = document.getElementById('pending-badge');
                if (data.total_count > 0) {
                    badge.textContent = data.total_count;
                    badge.style.display = 'inline-block';
                    
                    // Animation de pulsation pour attirer l'attention
                    badge.style.animation = 'pulse 1.5s ease-in-out infinite';
                } else {
                    badge.style.display = 'none';
                }
            })
            .catch(error => console.error('Erreur lors de la récupération du compteur:', error));
    }
    
    // Mettre à jour immédiatement
    updatePendingRequestsCount();
    
    // Puis mettre à jour toutes les 15 secondes
    setInterval(updatePendingRequestsCount, 15000);
</script>

<style>
    @keyframes pulse {
        0%, 100% {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
        }
        50% {
            opacity: 0.8;
            transform: translate(-50%, -50%) scale(1.1);
        }
    }
</style>
{% endblock %}
