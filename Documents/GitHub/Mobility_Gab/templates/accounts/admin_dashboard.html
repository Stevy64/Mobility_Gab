{% extends 'core/dashboard/base.html' %}

{% block dashboard_title %}Espace Administrateur{% endblock %}
{% block dashboard_subtitle %}Vue globale des activités chauffeurs & particuliers{% endblock %}

{% block dashboard_actions %}
<a href="{% url 'admin:index' %}" class="btn btn-outline-secondary"><i class="bi bi-gear"></i> Django Admin</a>
{% endblock %}

{% block dashboard_content %}
<div class="row g-4">
    <div class="col-md-4">
        <div class="card card-kpi shadow-sm border-0 p-3 h-100">
            <div class="d-flex align-items-center">
                <div class="bg-primary bg-opacity-10 text-primary rounded-circle p-3">
                    <i class="bi bi-people fs-4"></i>
                </div>
                <div class="ms-3">
                    <p class="text-muted small mb-1">Particuliers</p>
                    <h3 class="mb-0">{{ total_parents }}</h3>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card card-kpi shadow-sm border-0 p-3 h-100">
            <div class="d-flex align-items-center">
                <div class="bg-success bg-opacity-10 text-success rounded-circle p-3">
                    <i class="bi bi-taxi-front fs-4"></i>
                </div>
                <div class="ms-3">
                    <p class="text-muted small mb-1">Chauffeurs</p>
                    <h3 class="mb-0">{{ total_chauffeurs }}</h3>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card card-kpi shadow-sm border-0 p-3 h-100">
            <div class="d-flex align-items-center">
                <div class="bg-warning bg-opacity-10 text-warning rounded-circle p-3">
                    <i class="bi bi-loop fs-4"></i>
                </div>
                <div class="ms-3">
                    <p class="text-muted small mb-1">Abonnements actifs</p>
                    <h3 class="mb-0">{{ active_subscriptions }}</h3>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row g-4 mt-1">
    <div class="col-xl-6">
        <div class="card shadow-sm border-0">
            <div class="card-body">
                <h5 class="fw-bold">Abonnements récents</h5>
                <div class="table-responsive">
                    <table class="table table-sm align-middle">
                        <thead class="text-muted">
                            <tr>
                                <th>Parent</th>
                                <th>Chauffeur</th>
                                <th>Plan</th>
                                <th>Statut</th>
                                <th>Début</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for sub in recent_subscriptions %}
                            <tr>
                                <td>{{ sub.parent.get_full_name|default:sub.parent.username }}</td>
                                <td>{{ sub.chauffeur.get_full_name|default:sub.chauffeur.username }}</td>
                                <td>{{ sub.plan.name }}</td>
                                <td><span class="badge bg-light text-dark">{{ sub.get_status_display }}</span></td>
                                <td>{{ sub.start_date|date:'d/m/Y' }}</td>
                            </tr>
                            {% empty %}
                            <tr><td colspan="5" class="text-center text-muted">Aucun abonnement récent.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xl-6">
        <div class="card shadow-sm border-0">
            <div class="card-body">
                <h5 class="fw-bold">Paiements récents</h5>
                <div class="table-responsive">
                    <table class="table table-sm align-middle">
                        <thead class="text-muted">
                            <tr>
                                <th>Abonné</th>
                                <th>Montant</th>
                                <th>Méthode</th>
                                <th>Statut</th>
                                <th>Date</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for payment in recent_payments %}
                            <tr>
                                <td>{{ payment.subscription.parent.get_full_name|default:payment.subscription.parent.username }}</td>
                                <td>{{ payment.amount }}</td>
                                <td>{{ payment.get_method_display }}</td>
                                <td><span class="badge bg-light text-dark">{{ payment.get_status_display }}</span></td>
                                <td>{{ payment.created_at|date:'d/m/Y H:i' }}</td>
                            </tr>
                            {% empty %}
                            <tr><td colspan="5" class="text-center text-muted">Aucun paiement récent.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row g-4 mt-1">
    <div class="col-xl-6">
        <div class="card shadow-sm border-0">
            <div class="card-body">
                <h5 class="fw-bold">Paiements en attente</h5>
                <p class="display-6 mb-0">{{ pending_payments }}</p>
                <p class="text-muted">Paiements nécessitant attention admin.</p>
            </div>
        </div>
    </div>
    <div class="col-xl-6">
        <div class="card shadow-sm border-0">
            <div class="card-body">
                <h5 class="fw-bold">Alertes SOS</h5>
                <p class="text-muted">L'équipe admin reçoit ces alertes en temps réel.</p>
                <ul class="list-group list-group-flush small">
                    {% for alert in sos_alerts %}
                    <li class="list-group-item">
                        <div class="fw-semibold">{{ alert.user.get_full_name|default:alert.user.username }}</div>
                        <div class="text-muted">{{ alert.created_at|date:'d/m/Y H:i' }}</div>
                        {% if alert.resolved %}
                            <span class="badge bg-success">Résolue</span>
                        {% else %}
                            <span class="badge bg-danger">En cours</span>
                        {% endif %}
                    </li>
                    {% empty %}
                    <li class="list-group-item text-muted">Aucune alerte récente.</li>
                    {% endfor %}
                </ul>
                <a href="#" class="btn btn-danger disabled w-100 mt-3">Centre SOS (bientôt)</a>
            </div>
        </div>
    </div>
</div>

<div class="row g-4 mt-1">
    <div class="col-12">
        <div class="card shadow-sm border-0">
            <div class="card-body">
                <h5 class="fw-bold">Notifications récentes</h5>
                <ul class="list-group list-group-flush small">
                    {% for notif in recent_notifications %}
                    <li class="list-group-item">
                        <div class="fw-semibold">{{ notif.title }}</div>
                        <div class="text-muted">{{ notif.user.get_full_name|default:notif.user.username }} • {{ notif.created_at|date:'d/m/Y H:i' }}</div>
                        <p class="mb-0">{{ notif.message }}</p>
                    </li>
                    {% empty %}
                    <li class="list-group-item text-muted">Aucune notification récente.</li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}
