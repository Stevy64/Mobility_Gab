{% extends 'base.html' %}

{% block page_title %}
    {% if is_chauffeur %}Gestion Course{% else %}Suivi Course{% endif %} - Mobility Gab
{% endblock %}

{% block extra_css %}
<!-- Leaflet CSS pour la carte -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
/* Variables couleur orange moderne */
:root {
    --orange-primary: #FF8C00;
    --orange-light: #FFA500;
    --orange-bright: #FFB733;
}

/* En-t√™te moderne */
.trip-management-header {
    background: linear-gradient(135deg, var(--orange-primary), var(--orange-light));
    color: white;
    border-radius: 16px;
    padding: 2rem;
    margin-bottom: 2rem;
    box-shadow: 0 8px 32px rgba(255, 140, 0, 0.3);
    position: relative;
    overflow: hidden;
}

.trip-management-header::before {
    content: '';
    position: absolute;
    top: -50%;
    right: -10%;
    width: 200px;
    height: 200px;
    background: radial-gradient(circle, rgba(255, 255, 255, 0.15), transparent);
    border-radius: 50%;
    animation: float 6s ease-in-out infinite;
}

@keyframes float {
    0%, 100% { transform: translate(0, 0) scale(1); }
    50% { transform: translate(-10px, -10px) scale(1.05); }
}

/* Carte GPS */
#map {
    height: 500px;
    border-radius: 16px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    margin-bottom: 2rem;
    z-index: 1;
}

/* Animation de la voiture sur la carte */
.custom-car-icon {
    transition: transform 0.5s ease;
    animation: carPulse 2s ease-in-out infinite;
}

@keyframes carPulse {
    0%, 100% { 
        filter: drop-shadow(0 4px 12px rgba(255, 140, 0, 0.5));
    }
    50% { 
        filter: drop-shadow(0 6px 20px rgba(255, 140, 0, 0.8));
    }
}

/* Style pour la ligne de route anim√©e */
.leaflet-pane svg path.leaflet-interactive {
    stroke-dasharray: 10, 5;
    animation: dashAnimation 20s linear infinite;
}

@keyframes dashAnimation {
    to {
        stroke-dashoffset: -1000;
    }
}

/* Timeline de progression */
.trip-progress {
    background: white;
    border-radius: 16px;
    padding: 2rem;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    margin-bottom: 2rem;
}

.progress-step {
    display: flex;
    align-items: flex-start;
    margin-bottom: 2rem;
    position: relative;
}

.progress-step:not(:last-child)::after {
    content: '';
    position: absolute;
    left: 24px;
    top: 50px;
    width: 3px;
    height: calc(100% + 1rem);
    background: linear-gradient(180deg, var(--orange-primary), rgba(255, 140, 0, 0.2));
}

.progress-step.completed::after {
    background: var(--bs-success);
}

.progress-step.current::after {
    background: linear-gradient(180deg, var(--orange-primary), rgba(255, 140, 0, 0.3));
    animation: pulse 2s ease-in-out infinite;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}

.progress-icon {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background: white;
    border: 3px solid #e9ecef;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.25rem;
    flex-shrink: 0;
    transition: all 0.3s ease;
    z-index: 2;
    position: relative;
}

.progress-step.completed .progress-icon {
    background: var(--bs-success);
    border-color: var(--bs-success);
    color: white;
}

.progress-step.current .progress-icon {
    background: linear-gradient(135deg, var(--orange-primary), var(--orange-light));
    border-color: var(--orange-primary);
    color: white;
    box-shadow: 0 4px 16px rgba(255, 140, 0, 0.4);
    animation: iconPulse 2s ease-in-out infinite;
}

@keyframes iconPulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.1); }
}

.progress-content {
    margin-left: 1rem;
    flex: 1;
}

.progress-title {
    font-weight: 700;
    font-size: 1.1rem;
    margin-bottom: 0.25rem;
    color: #212529;
}

.progress-time {
    font-size: 0.85rem;
    color: #6c757d;
}

.progress-description {
    font-size: 0.9rem;
    color: #6c757d;
    margin-top: 0.5rem;
}

/* Stats cards */
.stat-card {
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: 0 2px 12px rgba(0, 0, 0, 0.06);
    text-align: center;
    transition: all 0.3s ease;
}

.stat-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
}

.stat-icon {
    width: 50px;
    height: 50px;
    border-radius: 12px;
    background: linear-gradient(135deg, rgba(255, 140, 0, 0.1), rgba(255, 183, 51, 0.1));
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    color: var(--orange-primary);
    margin: 0 auto 1rem;
}

.stat-value {
    font-size: 1.75rem;
    font-weight: 800;
    color: #212529;
    margin-bottom: 0.25rem;
}

.stat-label {
    font-size: 0.875rem;
    color: #6c757d;
    font-weight: 500;
}

/* Section informations */
.info-card {
    background: white;
    border-radius: 16px;
    padding: 1.5rem;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    margin-bottom: 1.5rem;
}

.info-card-header {
    display: flex;
    align-items: center;
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 2px solid #f8f9fa;
}

.info-card-header i {
    font-size: 1.5rem;
    color: var(--orange-primary);
    margin-right: 0.75rem;
}

.info-card-header h6 {
    margin: 0;
    font-weight: 700;
    font-size: 1.1rem;
}

.info-item {
    display: flex;
    align-items: flex-start;
    margin-bottom: 1rem;
    padding: 0.75rem;
    background: #f8f9fa;
    border-radius: 8px;
}

.info-item i {
    color: var(--orange-primary);
    margin-right: 0.75rem;
    margin-top: 0.25rem;
    font-size: 1.1rem;
}

.info-item-content {
    flex: 1;
}

.info-item-label {
    font-size: 0.8rem;
    color: #6c757d;
    margin-bottom: 0.25rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.info-item-value {
    font-size: 1rem;
    color: #212529;
    font-weight: 500;
}

/* User profile card */
.user-profile-card {
    background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
    border-radius: 16px;
    padding: 2rem;
    text-align: center;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
}

.user-avatar {
    width: 100px;
    height: 100px;
    border-radius: 50%;
    object-fit: cover;
    border: 4px solid white;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
    margin: 0 auto 1rem;
}

.user-avatar-placeholder {
    width: 100px;
    height: 100px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--orange-primary), var(--orange-light));
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 1rem;
    font-size: 2.5rem;
    color: white;
    box-shadow: 0 4px 16px rgba(255, 140, 0, 0.3);
}

.user-name {
    font-size: 1.25rem;
    font-weight: 700;
    color: #212529;
    margin-bottom: 0.25rem;
}

.user-role {
    font-size: 0.9rem;
    color: #6c757d;
    margin-bottom: 1rem;
}

.user-info-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem;
    background: white;
    border-radius: 8px;
    margin-bottom: 0.5rem;
}

/* Chat moderne (Mobility+) - Style Chatbot Bubble */
.chat-bubble-wrapper {
    position: fixed;
    bottom: 24px;
    right: 24px;
    z-index: 9999;
}

.chat-bubble-button {
    width: 64px;
    height: 64px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--orange-primary), var(--orange-light));
    border: none;
    box-shadow: 0 8px 24px rgba(255, 140, 0, 0.4);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 26px;
    transition: all 0.3s ease;
    position: relative;
}

.chat-bubble-button:hover {
    transform: scale(1.1);
    box-shadow: 0 12px 32px rgba(255, 140, 0, 0.5);
}

.chat-bubble-button.active {
    background: linear-gradient(135deg, #dc2626, #ef4444);
}

.chat-notification-badge {
    position: absolute;
    top: -4px;
    right: -4px;
    background: #dc2626;
    color: white;
    border-radius: 50%;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    font-weight: bold;
    border: 3px solid white;
    animation: pulse 2s ease-in-out infinite;
}

.chat-window {
    position: fixed;
    bottom: 100px;
    right: 24px;
    width: 400px;
    max-width: calc(100vw - 48px);
    height: 600px;
    max-height: calc(100vh - 140px);
    background: white;
    border-radius: 20px;
    box-shadow: 0 12px 48px rgba(0, 0, 0, 0.2);
    display: none;
    flex-direction: column;
    overflow: hidden;
    z-index: 9998;
    animation: slideInUp 0.3s ease;
}

.chat-window.open {
    display: flex;
}

@keyframes slideInUp {
    from {
        opacity: 0;
        transform: translateY(20px) scale(0.95);
    }
    to {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}

.chat-window-header {
    background: linear-gradient(135deg, var(--orange-primary), var(--orange-light));
    color: white;
    padding: 1.25rem 1.5rem;
    display: flex;
    align-items: center;
    justify-content: space-between;
    border-radius: 20px 20px 0 0;
}

.chat-window-header-info {
    display: flex;
    align-items: center;
    gap: 12px;
}

.chat-window-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.2);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    border: 2px solid rgba(255, 255, 255, 0.3);
}

.chat-window-title {
    font-size: 16px;
    font-weight: 600;
    margin: 0;
}

.chat-window-status {
    font-size: 12px;
    opacity: 0.9;
}

.chat-window-close {
    background: rgba(255, 255, 255, 0.2);
    border: none;
    color: white;
    width: 32px;
    height: 32px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s ease;
}

.chat-window-close:hover {
    background: rgba(255, 255, 255, 0.3);
}

.chat-container {
    flex: 1;
    overflow-y: auto;
    padding: 1.5rem;
    background: #f8f9fa;
}

.chat-container::-webkit-scrollbar {
    width: 6px;
}

.chat-container::-webkit-scrollbar-thumb {
    background: rgba(0, 0, 0, 0.2);
    border-radius: 3px;
}

.chat-container::-webkit-scrollbar-track {
    background: transparent;
}

.message {
    display: flex;
    margin-bottom: 1rem;
    animation: fadeInUp 0.3s ease;
}

@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.message.own {
    justify-content: flex-end;
}

.message-bubble {
    max-width: 70%;
    padding: 0.875rem 1.125rem;
    border-radius: 16px;
    position: relative;
    word-wrap: break-word;
}

.message.own .message-bubble {
    background: linear-gradient(135deg, var(--orange-primary), var(--orange-light));
    color: white;
    border-bottom-right-radius: 4px;
}

.message:not(.own) .message-bubble {
    background: white;
    color: #212529;
    border: 1px solid #e9ecef;
    border-bottom-left-radius: 4px;
}

.message-time {
    font-size: 0.7rem;
    opacity: 0.8;
    margin-top: 0.375rem;
}

.message-input-container {
    display: flex;
    gap: 0.75rem;
    padding: 1rem;
    background: white;
    border-radius: 12px;
}

.message-input-container input {
    border-radius: 24px;
    border: 2px solid #e9ecef;
    padding: 0.75rem 1.25rem;
    transition: all 0.3s ease;
}

.message-input-container input:focus {
    border-color: var(--orange-primary);
    box-shadow: 0 0 0 3px rgba(255, 140, 0, 0.1);
}

.message-input-container button {
    border-radius: 50%;
    width: 48px;
    height: 48px;
    background: linear-gradient(135deg, var(--orange-primary), var(--orange-light));
    border: none;
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
    cursor: pointer;
    flex-shrink: 0;
}

.message-input-container button:hover {
    transform: scale(1.1);
    box-shadow: 0 4px 12px rgba(255, 140, 0, 0.4);
}

.message-input-container button:active {
    transform: scale(0.95);
}

.chat-input-wrapper {
    padding: 1rem 1.5rem;
    background: white;
    border-top: 1px solid #e9ecef;
}

/* Mobile responsive pour chat bubble */
@media (max-width: 576px) {
    .chat-window {
        width: 100vw !important;
        height: 100vh !important;
        max-height: 100vh !important;
        bottom: 0 !important;
        right: 0 !important;
        border-radius: 0 !important;
    }
    
    .chat-bubble-wrapper {
        bottom: 16px !important;
        right: 16px !important;
    }
    
    .chat-bubble-button {
        width: 56px !important;
        height: 56px !important;
        font-size: 22px !important;
    }
}

.message-input-container button:hover {
    transform: scale(1.1);
    box-shadow: 0 4px 16px rgba(255, 140, 0, 0.4);
}

/* Boutons d'action */
.action-btn {
    padding: 0.875rem 1.75rem;
    border-radius: 12px;
    font-weight: 600;
    font-size: 1rem;
    transition: all 0.3s ease;
    border: none;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
}

.action-btn-primary {
    background: linear-gradient(135deg, var(--orange-primary), var(--orange-light));
    color: white;
}

.action-btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 24px rgba(255, 140, 0, 0.4);
    color: white;
}

.action-btn-success {
    background: linear-gradient(135deg, #28a745, #20c997);
    color: white;
}

.action-btn-success:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 24px rgba(40, 167, 69, 0.4);
    color: white;
}

.action-btn-secondary {
    background: #f8f9fa;
    color: #6c757d;
    border: 2px solid #e9ecef;
}

.action-btn-secondary:hover {
    background: #e9ecef;
    color: #495057;
}

/* Badge Mobility+ */
.mobility-plus-badge {
    background: linear-gradient(135deg, #ffd700, #ffed4e);
    color: #000;
    font-weight: 700;
    font-size: 0.8rem;
    padding: 0.375rem 0.875rem;
    border-radius: 20px;
    display: inline-flex;
    align-items: center;
    gap: 0.375rem;
    box-shadow: 0 2px 8px rgba(255, 215, 0, 0.4);
}

/* Refresh indicator */
.refresh-indicator {
    position: fixed;
    bottom: 2rem;
    right: 2rem;
    background: linear-gradient(135deg, var(--orange-primary), var(--orange-light));
    color: white;
    padding: 0.875rem 1.5rem;
    border-radius: 50px;
    box-shadow: 0 4px 16px rgba(255, 140, 0, 0.4);
    display: none;
    align-items: center;
    gap: 0.75rem;
    z-index: 1000;
    animation: slideInUp 0.3s ease;
}

@keyframes slideInUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.refresh-indicator.active {
    display: flex;
}

.spinner-small {
    width: 16px;
    height: 16px;
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-top-color: white;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

/* Responsive */
@media (max-width: 768px) {
    .trip-management-header {
        padding: 1.5rem;
    }
    
    #map {
        height: 350px;
    }
    
    .trip-progress {
        padding: 1.5rem;
    }
    
    .progress-icon {
        width: 40px;
        height: 40px;
        font-size: 1rem;
    }
    
    .stat-card {
        margin-bottom: 1rem;
    }
    
    .message-bubble {
        max-width: 85%;
    }
    
    .user-profile-card {
        padding: 1.5rem;
    }
    
    .refresh-indicator {
        bottom: 1rem;
        right: 1rem;
        padding: 0.75rem 1.25rem;
        font-size: 0.875rem;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid px-3 px-md-4">
    <!-- En-t√™te de la course -->
    <div class="trip-management-header">
        <div class="d-flex align-items-center justify-content-between flex-wrap gap-3">
            <div>
                <h2 class="h3 mb-2 fw-bold">
                        <i class="bi bi-car-front me-2"></i>
                        {% if is_chauffeur %}Gestion de Course{% else %}Suivi de Course{% endif %}
                    </h2>
                    <p class="mb-0 opacity-90">
                        Course #{{ trip.id }} - {{ trip.get_status_display }}
                    {% if has_mobility_plus %}
                    <span class="mobility-plus-badge ms-2">
                        <i class="bi bi-star-fill"></i>
                        Mobility Plus
                    </span>
                    {% endif %}
                    </p>
                </div>
            <div class="d-flex gap-2">
                    {% if trip.status == 'in_progress' %}
                <span class="badge bg-success px-3 py-2">
                    <i class="bi bi-broadcast"></i> En direct
                </span>
                    {% elif trip.status == 'scheduled' %}
                <span class="badge bg-warning text-dark px-3 py-2">
                    <i class="bi bi-clock"></i> Programm√©
                </span>
                    {% elif trip.status == 'completed' %}
                <span class="badge bg-info px-3 py-2">
                    <i class="bi bi-check-circle"></i> Termin√©
                                </span>
                    {% endif %}
                                </div>
                                </div>
                                </div>

    <div class="row">
        <!-- Colonne principale: Carte et progression -->
        <div class="col-lg-8 mb-4">
            <!-- Carte GPS en temps r√©el -->
            <div id="map"></div>

            <!-- Timeline de progression du trajet -->
            <div class="trip-progress">
                <div class="d-flex align-items-center justify-content-between mb-4">
                    <h5 class="mb-0 fw-bold">
                        <i class="bi bi-map me-2"></i>
                        Progression du trajet
                    </h5>
                    <div id="refreshTimer" class="text-muted small">
                        Actualisation dans <span id="countdown">{{ has_mobility_plus|yesno:"15,60" }}</span>s
                </div>
            </div>

                <div id="progressTimeline">
                    <!-- Timeline sera g√©n√©r√©e par JavaScript -->
                </div>
                    </div>
                    
            <!-- Stats de la course -->
            {% if trip.status == 'in_progress' or trip.status == 'completed' %}
            <div class="row g-3 mb-4">
                <div class="col-6 col-md-3">
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="bi bi-speedometer"></i>
                        </div>
                        <div class="stat-value" id="distanceValue">
                            {{ trip.distance_km|default:"--" }}
                    </div>
                        <div class="stat-label">Kilom√®tres</div>
                        </div>
                    </div>
                <div class="col-6 col-md-3">
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="bi bi-clock"></i>
                </div>
                        <div class="stat-value" id="durationValue">
                            {{ trip.duration_minutes|default:"--" }}
            </div>
                        <div class="stat-label">Minutes</div>
                        </div>
                    </div>
                <div class="col-6 col-md-3">
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="bi bi-geo-alt"></i>
                </div>
                        <div class="stat-value" id="checkpointsValue">0</div>
                        <div class="stat-label">Points GPS</div>
                    </div>
                    </div>
                <div class="col-6 col-md-3">
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="bi bi-activity"></i>
                    </div>
                        <div class="stat-value" id="statusValue">
                            {% if trip.status == 'in_progress' %}
                            <span class="text-success">Actif</span>
                            {% elif trip.status == 'completed' %}
                            <span class="text-info">Fini</span>
                            {% else %}
                            --
                {% endif %}
            </div>
                        <div class="stat-label">Statut</div>
        </div>
                </div>
            </div>
            {% endif %}

            {% if messages %}
            <!-- Chat Bubble Flottant (Style Chatbot moderne) -->
            <div class="chat-bubble-wrapper">
                <button class="chat-bubble-button" id="chatBubbleBtn" onclick="toggleChatWindow()">
                    <i class="bi bi-chat-dots-fill"></i>
                    <span class="chat-notification-badge" id="chatNotificationBadge" style="display: none;">0</span>
                </button>
            </div>

            <!-- Fen√™tre de chat -->
            <div class="chat-window" id="chatWindow">
                <!-- En-t√™te -->
                <div class="chat-window-header">
                    <div class="chat-window-header-info">
                        <div class="chat-window-avatar">
                            <i class="bi bi-person-fill"></i>
                        </div>
                        <div>
                            <div class="chat-window-title">{{ other_user.name }}</div>
                            <div class="chat-window-status">
                                {% if has_mobility_plus %}
                                <i class="bi bi-star-fill"></i> Mobility Plus actif
                                {% else %}
                                En ligne
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    <button class="chat-window-close" onclick="toggleChatWindow()">
                        <i class="bi bi-x-lg"></i>
                    </button>
                </div>

                <!-- Container des messages -->
                <div class="chat-container" id="chatContainer">
                    <!-- Messages charg√©s via JavaScript -->
                </div>
                
                {% if has_mobility_plus %}
                <!-- Zone de saisie pour abonn√©s Mobility+ -->
                <div class="chat-input-wrapper">
                    <div class="message-input-container">
                        <input type="text" class="form-control" id="messageInput" 
                               placeholder="Tapez votre message..." maxlength="500" 
                               onkeypress="if(event.key === 'Enter') sendMessage()">
                        <button type="button" onclick="sendMessage()">
                            <i class="bi bi-send-fill"></i>
                        </button>
                    </div>
                </div>
                {% else %}
                <!-- Notification pour non-abonn√©s : ils peuvent voir mais pas r√©pondre -->
                <div class="chat-input-wrapper">
                    <div class="alert alert-warning border-0 mb-0 rounded-3">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-lock-fill me-3" style="font-size: 1.5rem;"></i>
                            <div class="flex-grow-1">
                                <h6 class="alert-heading mb-1 fw-bold" style="font-size: 0.9rem;">
                                    <i class="bi bi-star-fill text-warning"></i>
                                    R√©pondre avec Mobility Plus
                                </h6>
                                <p class="mb-2 small" style="font-size: 0.8rem;">
                                    Vous recevez les messages, mais ne pouvez pas r√©pondre.
                                </p>
                                <a href="{% url 'subscriptions:new_subscription_system' %}" class="btn btn-sm btn-warning fw-bold" style="font-size: 0.8rem;">
                                    <i class="bi bi-star-fill me-1"></i>
                                    S'abonner
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
            {% elif not has_mobility_plus and not other_has_mobility_plus %}
            <!-- Aucun des deux n'a Mobility Plus -->
            <div class="alert alert-info border-0 shadow-sm d-flex align-items-center">
                <i class="bi bi-star-fill me-3" style="font-size: 2rem;"></i>
                                    <div>
                    <h6 class="alert-heading mb-1 fw-bold">Passez √† Mobility Plus</h6>
                    <p class="mb-2">
                        D√©bloquez le chat en temps r√©el, actualisation GPS toutes les 15s, 
                        statistiques d√©taill√©es et donn√©es exploitables de vos trajets.
                    </p>
                    <a href="{% url 'subscriptions:new_subscription_system' %}" class="btn btn-sm btn-primary">
                        <i class="bi bi-star-fill me-1"></i>
                        D√©couvrir Mobility Plus
                    </a>
                </div>
            </div>
                                        {% endif %}
                                    </div>

        <!-- Colonne droite: Informations et actions -->
        <div class="col-lg-4">
            <!-- Informations de l'autre utilisateur -->
            <div class="user-profile-card mb-4">
                {% if other_user.avatar %}
                    <img src="{{ other_user.avatar.url }}" alt="Avatar" class="user-avatar">
                {% else %}
                    <div class="user-avatar-placeholder">
                        <i class="bi bi-person-fill"></i>
                                </div>
                {% endif %}
                <div class="user-name">{{ other_user.name }}</div>
                <div class="user-role">{{ other_user.role }}</div>
                
                {% if not is_chauffeur and other_user.vehicle %}
                    <div class="user-info-item">
                        <span class="text-muted"><i class="bi bi-car-front me-2"></i>V√©hicule</span>
                        <strong>{{ other_user.vehicle }}</strong>
                            </div>
                    <div class="user-info-item">
                        <span class="text-muted"><i class="bi bi-hash me-2"></i>Plaque</span>
                        <strong>{{ other_user.plate }}</strong>
                    </div>
                    <div class="user-info-item">
                        <span class="text-muted"><i class="bi bi-star-fill me-2"></i>Note</span>
                        <strong>{{ other_user.rating }}/5</strong>
                </div>
                {% endif %}
            </div>

            <!-- Informations du trajet -->
            <div class="info-card mb-4">
                <div class="info-card-header">
                    <i class="bi bi-geo-alt-fill"></i>
                    <h6>Informations du trajet</h6>
        </div>
                
                <div class="info-item">
                    <i class="bi bi-record-circle text-primary"></i>
                    <div class="info-item-content">
                        <div class="info-item-label">D√©part</div>
                        <div class="info-item-value">{{ pickup_location|default:"Non sp√©cifi√©" }}</div>
    </div>
</div>

                <div class="info-item">
                    <i class="bi bi-flag-fill text-success"></i>
                    <div class="info-item-content">
                        <div class="info-item-label">Destination</div>
                        <div class="info-item-value">{{ dropoff_location|default:"Non sp√©cifi√©" }}</div>
            </div>
                    </div>
                    
                <div class="info-item">
                    <i class="bi bi-clock-fill text-info"></i>
                    <div class="info-item-content">
                        <div class="info-item-label">Heure pr√©vue</div>
                        <div class="info-item-value">
                            {% if pickup_time %}
                                {{ pickup_time|time:"H:i" }}
                            {% else %}
                                Non sp√©cifi√©
                            {% endif %}
                    </div>
            </div>
                </div>
            </div>

            <!-- Actions -->
            <div class="info-card">
                <div class="info-card-header">
                    <i class="bi bi-gear-fill"></i>
                    <h6>Actions</h6>
                </div>
                
                <div class="d-grid gap-2">
                    {% if is_chauffeur %}
                        {% if trip.status == 'scheduled' %}
                            <button class="action-btn action-btn-primary" id="startTripBtn" onclick="startTrip()">
                                <i class="bi bi-play-fill"></i>
                                D√©marrer la course
                </button>
                        {% endif %}
                        {% if trip.status == 'in_progress' %}
                            <button class="action-btn action-btn-success" id="chauffeurConfirmBtn" 
                                    onclick="confirmTrip('chauffeur')"
                                    {{ chauffeur_confirmed|yesno:"disabled," }}>
                                <i class="bi bi-check2-circle"></i>
                                {% if chauffeur_confirmed %}Arriv√©e confirm√©e{% else %}Confirmer l'arriv√©e{% endif %}
                            </button>
                        {% endif %}
                    {% else %}
                        {% if trip.status == 'in_progress' %}
                            <button class="action-btn action-btn-success" id="parentConfirmBtn" 
                                    onclick="confirmTrip('parent')"
                                    {{ parent_confirmed|yesno:"disabled," }}>
                                <i class="bi bi-check2-circle"></i>
                                {% if parent_confirmed %}Arriv√©e confirm√©e{% else %}Confirmer l'arriv√©e{% endif %}
                            </button>
                        {% endif %}
                    {% endif %}

                    {% if trip.status == 'completed' %}
                        <button class="action-btn action-btn-secondary" onclick="archiveTrip()">
                            <i class="bi bi-archive"></i>
                            Archiver la course
                        </button>
                    {% endif %}
            </div>

                <!-- Statut de confirmation -->
                {% if trip.status == 'in_progress' %}
                <div class="mt-3 p-3 bg-light rounded">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="small">
                            <i class="bi bi-steering-wheel me-1"></i> Chauffeur
                        </span>
                        {% if chauffeur_confirmed %}
                            <span class="badge bg-success">‚úì Confirm√©</span>
                        {% else %}
                            <span class="badge bg-secondary">En attente</span>
                        {% endif %}
        </div>
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="small">
                            <i class="bi bi-person me-1"></i> Passager
                        </span>
                        {% if parent_confirmed %}
                            <span class="badge bg-success">‚úì Confirm√©</span>
                        {% else %}
                            <span class="badge bg-secondary">En attente</span>
                        {% endif %}
    </div>
</div>
{% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Indicateur de rafra√Æchissement -->
<div class="refresh-indicator" id="refreshIndicator">
    <div class="spinner-small"></div>
    <span>Actualisation GPS...</span>
</div>
{% endblock %}

{% block extra_js %}
<!-- Leaflet JS pour la carte -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const tripId = {{ trip.id }};
const hasMobilityPlus = {{ has_mobility_plus|yesno:"true,false" }};
const refreshInterval = hasMobilityPlus ? 15000 : 60000; // 15s avec Mobility+, 60s sans
let refreshIntervalId;
let countdownIntervalId;
let countdownSeconds = hasMobilityPlus ? 15 : 60;

// Initialiser la carte
let map;
let markers = {
    chauffeur: null,
    pickup: null,
    dropoff: null,
};
let routeLine = null;
let checkpointMarkers = [];
let previousCarPosition = null;
let carAnimationInterval = null;

function initMap() {
    // Cr√©er la carte centr√©e sur Libreville, Gabon par d√©faut
    map = L.map('map').setView([0.4162, 9.4673], 13);

    // Ajouter la couche de carte
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors',
        maxZoom: 19,
    }).addTo(map);

    // Ic√¥ne personnalis√©e pour le chauffeur
    const carIcon = L.divIcon({
        html: '<div style="background: linear-gradient(135deg, #FF8C00, #FFA500); width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 20px; box-shadow: 0 4px 12px rgba(255,140,0,0.5);"><i class="bi bi-car-front-fill"></i></div>',
        className: 'custom-car-icon',
        iconSize: [40, 40],
        iconAnchor: [20, 20],
    });

    // Charger les donn√©es GPS
    loadGPSData();
}

function loadGPSData() {
    showRefreshIndicator();
    
    fetch(`/courses/api/trip/${tripId}/gps-location/`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updateMap(data);
                updateProgressTimeline(data);
                updateStats(data);
            }
        })
        .catch(error => console.error('Erreur GPS:', error))
        .finally(() => hideRefreshIndicator());
}

function updateMap(data) {
    const { current_location, route_info, checkpoints } = data;

    // Mettre √† jour la position du chauffeur avec animation
    if (current_location.latitude && current_location.longitude) {
        const newPosition = {
            lat: current_location.latitude,
            lng: current_location.longitude
        };

        const carIcon = L.divIcon({
            html: `<div style="background: linear-gradient(135deg, #FF8C00, #FFA500); width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 20px; box-shadow: 0 4px 12px rgba(255,140,0,0.5); transition: all 0.5s ease;"><i class="bi bi-car-front-fill"></i></div>`,
            className: 'custom-car-icon',
            iconSize: [40, 40],
            iconAnchor: [20, 20],
        });

        if (markers.chauffeur) {
            // Animer le d√©placement de la voiture
            const oldPosition = markers.chauffeur.getLatLng();
            animateCarMovement(oldPosition, newPosition, markers.chauffeur);
    } else {
            // Cr√©er le marqueur initial
            markers.chauffeur = L.marker([newPosition.lat, newPosition.lng], { icon: carIcon })
                .addTo(map)
                .bindPopup('<strong>üöó Chauffeur</strong><br>Position actuelle');
            previousCarPosition = newPosition;
        }

        // Centrer la carte sur le chauffeur (seulement si n√©cessaire)
        const currentBounds = map.getBounds();
        if (!currentBounds.contains([newPosition.lat, newPosition.lng])) {
            map.setView([newPosition.lat, newPosition.lng], 14, {
                animate: true,
                duration: 1
            });
        }
    }

    // Ajouter les marqueurs de d√©part et destination
    if (route_info.pickup && route_info.pickup.latitude) {
        const pickupIcon = L.divIcon({
            html: '<div style="background: #007bff; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 16px; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3);"><i class="bi bi-record-circle"></i></div>',
            className: 'custom-pickup-icon',
            iconSize: [32, 32],
            iconAnchor: [16, 16],
        });

        if (!markers.pickup) {
            markers.pickup = L.marker([route_info.pickup.latitude, route_info.pickup.longitude], { icon: pickupIcon })
                .addTo(map)
                .bindPopup(`<strong>üìç D√©part</strong><br>${route_info.pickup.location}`);
        }
    }

    if (route_info.dropoff && route_info.dropoff.latitude) {
        const dropoffIcon = L.divIcon({
            html: '<div style="background: #28a745; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 16px; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3);"><i class="bi bi-flag-fill"></i></div>',
            className: 'custom-dropoff-icon',
            iconSize: [32, 32],
            iconAnchor: [16, 16],
        });

        if (!markers.dropoff) {
            markers.dropoff = L.marker([route_info.dropoff.latitude, route_info.dropoff.longitude], { icon: dropoffIcon })
                .addTo(map)
                .bindPopup(`<strong>üèÅ Destination</strong><br>${route_info.dropoff.location}`);
        }
    }

    // Mettre √† jour les checkpoints
    updateCheckpointsOnMap(checkpoints);

    // Tracer la ligne de route avec animation
    if (checkpoints.length > 0) {
        const latlngs = checkpoints.map(cp => [cp.latitude, cp.longitude]);
        if (current_location.latitude && current_location.longitude) {
            latlngs.push([current_location.latitude, current_location.longitude]);
        }

        if (routeLine) {
            routeLine.setLatLngs(latlngs);
        } else {
            // Cr√©er une ligne de route stylis√©e avec effet gradient
            routeLine = L.polyline(latlngs, {
                color: '#FF8C00',
                weight: 5,
                opacity: 0.8,
                smoothFactor: 2,
                lineCap: 'round',
                lineJoin: 'round',
            }).addTo(map);
            
            // Ajouter une deuxi√®me ligne plus fine pour cr√©er un effet de bordure
            const routeOutline = L.polyline(latlngs, {
                color: '#FFB733',
                weight: 8,
                opacity: 0.3,
                smoothFactor: 2,
                lineCap: 'round',
                lineJoin: 'round',
            }).addTo(map);
            
            // Stocker les deux lignes
            routeLine.outline = routeOutline;
        }
        
        // Mettre √† jour l'outline si elle existe
        if (routeLine.outline) {
            routeLine.outline.setLatLngs(latlngs);
        }

        // Ajuster la vue pour inclure tous les points (seulement lors du premier chargement)
        if (!previousCarPosition) {
            const bounds = L.latLngBounds(latlngs);
            if (route_info.pickup && route_info.pickup.latitude) {
                bounds.extend([route_info.pickup.latitude, route_info.pickup.longitude]);
            }
            if (route_info.dropoff && route_info.dropoff.latitude) {
                bounds.extend([route_info.dropoff.latitude, route_info.dropoff.longitude]);
            }
            map.fitBounds(bounds, { padding: [50, 50] });
        }
    }
}

function updateCheckpointsOnMap(checkpoints) {
    // Supprimer les anciens marqueurs de checkpoints
    checkpointMarkers.forEach(marker => map.removeLayer(marker));
    checkpointMarkers = [];

    // Ajouter les nouveaux checkpoints
    checkpoints.forEach((cp, index) => {
        const cpIcon = L.divIcon({
            html: `<div style="background: rgba(255, 140, 0, 0.2); width: 20px; height: 20px; border-radius: 50%; border: 2px solid #FF8C00;"></div>`,
            className: 'custom-checkpoint-icon',
            iconSize: [20, 20],
            iconAnchor: [10, 10],
        });

        const marker = L.marker([cp.latitude, cp.longitude], { icon: cpIcon })
            .addTo(map)
            .bindPopup(`<strong>${cp.type_display}</strong><br>${cp.notes || ''}<br><small>${new Date(cp.timestamp).toLocaleTimeString()}</small>`);
        
        checkpointMarkers.push(marker);
    });
}

function updateProgressTimeline(data) {
    const { checkpoints, trip_status } = data;
    const timeline = document.getElementById('progressTimeline');

    // D√©finir les √©tapes du trajet
    const steps = [
        { key: 'scheduled', icon: 'clock', title: 'Course programm√©e', type: 'scheduled' },
        { key: 'started', icon: 'play-circle', title: 'Course d√©marr√©e', type: 'started' },
        { key: 'en_route', icon: 'car-front', title: 'En route', type: 'en_route' },
        { key: 'arrived', icon: 'geo-alt', title: 'Arriv√© au d√©part', type: 'arrived' },
        { key: 'child_picked', icon: 'person-check', title: 'Passager r√©cup√©r√©', type: 'child_picked' },
        { key: 'destination', icon: 'flag', title: 'En route vers destination', type: 'en_route' },
        { key: 'completed', icon: 'check-circle', title: 'Course termin√©e', type: 'completed' },
    ];

    let html = '';
    let currentStep = -1;

    // D√©terminer l'√©tape actuelle
    if (trip_status.status === 'completed') {
        currentStep = steps.length - 1;
    } else if (trip_status.status === 'in_progress') {
        currentStep = checkpoints.length > 0 ? Math.min(checkpoints.length + 1, steps.length - 2) : 1;
    } else if (trip_status.status === 'scheduled') {
        currentStep = 0;
    }

    steps.forEach((step, index) => {
        const isCompleted = index < currentStep;
        const isCurrent = index === currentStep;
        const statusClass = isCompleted ? 'completed' : (isCurrent ? 'current' : '');

        let timeInfo = '';
        if (index === 0 && trip_status.status === 'scheduled') {
            timeInfo = `<div class="progress-time">Planifi√©</div>`;
        } else if (index === 1 && trip_status.started_at) {
            timeInfo = `<div class="progress-time">${new Date(trip_status.started_at).toLocaleTimeString()}</div>`;
        } else if (index === steps.length - 1 && trip_status.completed_at) {
            timeInfo = `<div class="progress-time">${new Date(trip_status.completed_at).toLocaleTimeString()}</div>`;
        } else {
            const checkpoint = checkpoints.find(cp => cp.type === step.type);
            if (checkpoint) {
                timeInfo = `<div class="progress-time">${new Date(checkpoint.timestamp).toLocaleTimeString()}</div>`;
            }
        }

        html += `
            <div class="progress-step ${statusClass}">
                <div class="progress-icon">
                    <i class="bi bi-${step.icon}"></i>
                </div>
                <div class="progress-content">
                    <div class="progress-title">${step.title}</div>
                    ${timeInfo}
                    ${isCurrent ? '<div class="progress-description text-success fw-bold">En cours...</div>' : ''}
                </div>
            </div>
        `;
    });

    timeline.innerHTML = html;
}

function updateStats(data) {
    const { checkpoints, trip_status, mobility_plus_data } = data;

    // Mettre √† jour le nombre de checkpoints
    document.getElementById('checkpointsValue').textContent = checkpoints.length;

    // Mettre √† jour la distance et la dur√©e si disponibles
    if (trip_status.distance_km) {
        document.getElementById('distanceValue').textContent = trip_status.distance_km.toFixed(2);
    }
    if (trip_status.duration_minutes) {
        document.getElementById('durationValue').textContent = trip_status.duration_minutes;
    }
    
    // Afficher les donn√©es Mobility+ si disponibles
    if (hasMobilityPlus && mobility_plus_data) {
        displayMobilityPlusData(mobility_plus_data);
    }
}

function displayMobilityPlusData(data) {
    // Cr√©er ou mettre √† jour une section pour les donn√©es Mobility+
    let mobilitySection = document.getElementById('mobility-plus-stats');
    if (!mobilitySection) {
        const progressCard = document.querySelector('.trip-progress');
        mobilitySection = document.createElement('div');
        mobilitySection.id = 'mobility-plus-stats';
        mobilitySection.className = 'info-card mt-4';
        mobilitySection.innerHTML = `
            <div class="info-card-header">
                <i class="bi bi-graph-up-arrow"></i>
                <h6>Statistiques avanc√©es</h6>
                <span class="mobility-plus-badge ms-auto">
                    <i class="bi bi-star-fill"></i>
                    Mobility+
                </span>
            </div>
            <div id="mobility-stats-content" class="p-3"></div>
        `;
        progressCard.parentNode.insertBefore(mobilitySection, progressCard.nextSibling);
    }
    
    const content = document.getElementById('mobility-stats-content');
    let html = '<div class="row g-3">';
    
    // Vitesse moyenne
    if (data.avg_speed_kmh) {
        html += `
            <div class="col-6">
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="bi bi-speedometer2"></i>
                    </div>
                    <div class="stat-value">${data.avg_speed_kmh}</div>
                    <div class="stat-label">km/h moyen</div>
                </div>
            </div>
        `;
    }
    
    // ETA (Temps estim√© d'arriv√©e)
    if (data.eta) {
        html += `
            <div class="col-6">
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="bi bi-hourglass-split"></i>
                    </div>
                    <div class="stat-value">${data.eta.minutes_remaining}</div>
                    <div class="stat-label">min restantes</div>
                </div>
            </div>
            <div class="col-6">
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="bi bi-pin-map"></i>
                    </div>
                    <div class="stat-value">${data.eta.distance_remaining_km}</div>
                    <div class="stat-label">km restants</div>
                </div>
            </div>
        `;
    }
    
    // Pr√©cision GPS
    html += `
        <div class="col-6">
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="bi bi-geo-fill"></i>
                </div>
                <div class="stat-value text-${data.gps_accuracy === 'high' ? 'success' : 'warning'}">${data.gps_accuracy === 'high' ? 'Haute' : 'Moyenne'}</div>
                <div class="stat-label">Pr√©cision GPS</div>
            </div>
        </div>
    `;
    
    html += '</div>';
    
    // Historique de vitesse
    if (data.speed_history && data.speed_history.length > 0) {
        html += `
            <div class="mt-3">
                <h6 class="small fw-bold text-muted mb-2">
                    <i class="bi bi-activity me-1"></i>
                    Historique de vitesse
                </h6>
                <div class="d-flex gap-2 flex-wrap">
        `;
        
        data.speed_history.forEach(point => {
            html += `
                <span class="badge bg-light text-dark border">
                    ${point.speed_kmh} km/h
                </span>
            `;
        });
        
        html += '</div></div>';
    }
    
    content.innerHTML = html;
}

// Calculer l'angle de rotation de la voiture en fonction de la direction
function calculateBearing(startLat, startLng, endLat, endLng) {
    const dLng = endLng - startLng;
    const y = Math.sin(dLng) * Math.cos(endLat);
    const x = Math.cos(startLat) * Math.sin(endLat) -
              Math.sin(startLat) * Math.cos(endLat) * Math.cos(dLng);
    const bearing = Math.atan2(y, x);
    return (bearing * 180 / Math.PI + 360) % 360; // Convertir en degr√©s (0-360)
}

// Animation fluide de la voiture entre deux positions GPS
function animateCarMovement(oldPos, newPos, marker) {
    // Nettoyer l'animation pr√©c√©dente si elle existe
    if (carAnimationInterval) {
        clearInterval(carAnimationInterval);
    }
    
    const startLat = oldPos.lat;
    const startLng = oldPos.lng;
    const endLat = newPos.lat;
    const endLng = newPos.lng;
    
    // Calculer l'angle de rotation de la voiture
    const bearing = calculateBearing(startLat, startLng, endLat, endLng);
    
    // Dur√©e de l'animation en fonction de la fr√©quence de rafra√Æchissement
    const animationDuration = hasMobilityPlus ? 15000 : 60000; // M√™me dur√©e que le refresh
    const frames = 60; // 60 frames pour une animation fluide
    const frameDuration = animationDuration / frames;
    
    let currentFrame = 0;
    
    carAnimationInterval = setInterval(() => {
        currentFrame++;
        
        if (currentFrame >= frames) {
            // Animation termin√©e
            marker.setLatLng([endLat, endLng]);
            updateCarIcon(marker, bearing);
            clearInterval(carAnimationInterval);
            carAnimationInterval = null;
            previousCarPosition = newPos;
            return;
        }
        
        // Interpolation lin√©aire (easing)
        const progress = currentFrame / frames;
        
        // Fonction d'easing pour un mouvement plus naturel
        const easeInOutCubic = progress < 0.5
            ? 4 * progress * progress * progress
            : 1 - Math.pow(-2 * progress + 2, 3) / 2;
        
        const currentLat = startLat + (endLat - startLat) * easeInOutCubic;
        const currentLng = startLng + (endLng - startLng) * easeInOutCubic;
        
        marker.setLatLng([currentLat, currentLng]);
        
        // Mettre √† jour l'orientation de la voiture
        if (currentFrame % 5 === 0) { // Mettre √† jour l'ic√¥ne toutes les 5 frames
            updateCarIcon(marker, bearing);
        }
    }, frameDuration);
}

// Mettre √† jour l'ic√¥ne de la voiture avec rotation
function updateCarIcon(marker, bearing) {
    const carIcon = L.divIcon({
        html: `<div style="background: linear-gradient(135deg, #FF8C00, #FFA500); width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 20px; box-shadow: 0 4px 12px rgba(255,140,0,0.5); transform: rotate(${bearing}deg); transition: transform 0.3s ease;">
                <i class="bi bi-car-front-fill" style="transform: rotate(-${bearing}deg);"></i>
              </div>`,
        className: 'custom-car-icon',
        iconSize: [40, 40],
        iconAnchor: [20, 20],
    });
    marker.setIcon(carIcon);
}

function showRefreshIndicator() {
    document.getElementById('refreshIndicator').classList.add('active');
}

function hideRefreshIndicator() {
    document.getElementById('refreshIndicator').classList.remove('active');
}

function startRefreshCycle() {
    // Rafra√Æchir imm√©diatement
    loadGPSData();

    // Compteur de rafra√Æchissement
    countdownSeconds = hasMobilityPlus ? 7 : 30;
    document.getElementById('countdown').textContent = countdownSeconds;

    // D√©marrer le compte √† rebours
    if (countdownIntervalId) clearInterval(countdownIntervalId);
    countdownIntervalId = setInterval(() => {
        countdownSeconds--;
        document.getElementById('countdown').textContent = countdownSeconds;
        if (countdownSeconds <= 0) {
            countdownSeconds = hasMobilityPlus ? 7 : 30;
        }
    }, 1000);

    // D√©marrer le rafra√Æchissement automatique
    if (refreshIntervalId) clearInterval(refreshIntervalId);
    refreshIntervalId = setInterval(loadGPSData, refreshInterval);
}

// === Chat Bubble (Style Chatbot) ===
{% if messages %}
let chatWindowOpen = false;
let unreadMessagesCount = 0;

function toggleChatWindow() {
    const chatWindow = document.getElementById('chatWindow');
    const chatBubbleBtn = document.getElementById('chatBubbleBtn');
    const chatNotificationBadge = document.getElementById('chatNotificationBadge');
    
    chatWindowOpen = !chatWindowOpen;
    
    if (chatWindowOpen) {
        chatWindow.classList.add('open');
        chatBubbleBtn.classList.add('active');
        chatBubbleBtn.innerHTML = '<i class="bi bi-x-lg"></i>';
        
        // R√©initialiser le compteur de messages non lus
        unreadMessagesCount = 0;
        chatNotificationBadge.style.display = 'none';
        
        // Charger les messages
        loadMessages();
        
        // Scroller en bas
        setTimeout(() => {
            const chatContainer = document.getElementById('chatContainer');
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }, 100);
    } else {
        chatWindow.classList.remove('open');
        chatBubbleBtn.classList.remove('active');
        chatBubbleBtn.innerHTML = '<i class="bi bi-chat-dots-fill"></i><span class="chat-notification-badge" id="chatNotificationBadge" style="display: none;">0</span>';
    }
}

function updateChatNotification(count) {
    if (!chatWindowOpen && count > 0) {
        const badge = document.getElementById('chatNotificationBadge');
        if (badge) {
            badge.textContent = count;
            badge.style.display = 'flex';
            unreadMessagesCount = count;
        }
    }
}

function loadMessages() {
    fetch(`/courses/api/trip/${tripId}/messages/`)
        .then(response => response.json())
        .then(data => {
            displayMessages(data.messages);
        })
        .catch(error => console.error('Erreur chargement messages:', error));
}

function displayMessages(messages) {
    const container = document.getElementById('chatContainer');
    
    if (!container) return;
    
    container.innerHTML = messages.map(msg => `
        <div class="message ${msg.is_own ? 'own' : ''}">
            <div class="message-bubble">
                <div class="message-text">${msg.message}</div>
                <div class="message-time">${msg.timestamp}</div>
            </div>
        </div>
    `).join('');
    
    // Scroll vers le bas
    container.scrollTop = container.scrollHeight;
}

{% if has_mobility_plus %}
// Fonction d'envoi de message (uniquement pour abonn√©s Mobility+)
function sendMessage() {
    const input = document.getElementById('messageInput');
    const message = input.value.trim();
    
    if (!message) return;
    
    input.disabled = true;
    
    const formData = new FormData();
    formData.append('message', message);
    
    fetch(`/courses/api/trip/${tripId}/send-message/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            input.value = '';
            loadMessages();
        } else {
            alert('Erreur lors de l\'envoi: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Erreur envoi message:', error);
        alert('Erreur de connexion');
    })
    .finally(() => {
        input.disabled = false;
        input.focus();
    });
}
{% endif %}

// D√©marrer le polling des messages
setInterval(loadMessages, 5000);

// Charger les messages au d√©marrage
document.addEventListener('DOMContentLoaded', loadMessages);
{% endif %}

// === Actions sur la course ===
function startTrip() {
    const button = document.getElementById('startTripBtn');
    button.disabled = true;
    button.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>D√©marrage...';

    fetch(`/courses/api/trip/${tripId}/start/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert(data.error || 'Impossible de d√©marrer la course.');
            button.disabled = false;
            button.innerHTML = '<i class="bi bi-play-fill"></i> D√©marrer la course';
        }
    })
    .catch(() => {
        alert('Erreur de connexion.');
        button.disabled = false;
        button.innerHTML = '<i class="bi bi-play-fill"></i> D√©marrer la course';
    });
}

function confirmTrip(actor) {
    const button = actor === 'chauffeur'
        ? document.getElementById('chauffeurConfirmBtn')
        : document.getElementById('parentConfirmBtn');

    if (button && button.disabled) return;

    button.disabled = true;
    button.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Confirmation...';

    fetch(`/courses/api/trip/${tripId}/confirm/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Si le trajet est termin√©, rediriger vers la page d'√©valuation
            if (data.trip && data.trip.status === 'completed') {
                window.location.href = `/courses/trip/${tripId}/rate/`;
            } else {
            location.reload();
            }
        } else {
            alert(data.error || 'Impossible de confirmer la course.');
            button.disabled = false;
        }
    })
    .catch(() => {
        alert('Erreur de connexion.');
        button.disabled = false;
    });
}

function archiveTrip() {
    if (confirm('√ätes-vous s√ªr de vouloir archiver cette course ?')) {
        fetch(`/courses/api/trip/${tripId}/archive/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message || 'Course archiv√©e');
                window.location.href = '/courses/actives/';
            } else {
                alert('Erreur: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Erreur archivage:', error);
            alert('Erreur de connexion');
        });
    }
}

// Initialiser au chargement de la page
document.addEventListener('DOMContentLoaded', function() {
    initMap();
    startRefreshCycle();
});

// Nettoyer les intervals avant de quitter
window.addEventListener('beforeunload', function() {
    if (refreshIntervalId) clearInterval(refreshIntervalId);
    if (countdownIntervalId) clearInterval(countdownIntervalId);
});
</script>
{% endblock %}
