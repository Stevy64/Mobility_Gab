{% extends 'base.html' %}

{% block page_title %}
    {% if is_chauffeur %}Gestion Course{% else %}Suivi Course{% endif %} - Mobility Gab
{% endblock %}

{% block extra_css %}
<style>
.trip-management-header {
    background: linear-gradient(135deg, var(--mg-primary), #0f4aa6);
    color: white;
    border-radius: 1rem 1rem 0 0;
}

.chat-container {
    height: 400px;
    overflow-y: auto;
    border: 1px solid #dee2e6;
    border-radius: 0.5rem;
    padding: 1rem;
    background: #f8f9fa;
}

.message {
    margin-bottom: 1rem;
    display: flex;
}

.message.own {
    justify-content: flex-end;
}

.message-bubble {
    max-width: 70%;
    padding: 0.75rem 1rem;
    border-radius: 1rem;
    position: relative;
}

.message.own .message-bubble {
    background: var(--mg-primary);
    color: white;
}

.message:not(.own) .message-bubble {
    background: white;
    border: 1px solid #dee2e6;
}

.message-time {
    font-size: 0.75rem;
    opacity: 0.7;
    margin-top: 0.25rem;
}

.trip-status {
    padding: 1rem;
    border-radius: 0.5rem;
    margin-bottom: 1rem;
}

.trip-status.in-progress {
    background: linear-gradient(135deg, rgba(27, 187, 138, 0.1), rgba(255, 255, 255, 0.8));
    border-left: 4px solid var(--mg-secondary);
}

.trip-status.scheduled {
    background: linear-gradient(135deg, rgba(255, 193, 7, 0.1), rgba(255, 255, 255, 0.8));
    border-left: 4px solid #ffc107;
}

.trip-status.completed {
    background: linear-gradient(135deg, rgba(40, 167, 69, 0.1), rgba(255, 255, 255, 0.8));
    border-left: 4px solid #28a745;
}

.status-update {
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 0.5rem;
    padding: 1rem;
    margin-bottom: 0.5rem;
}

.user-avatar {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    object-fit: cover;
}

.user-info-card {
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 0.5rem;
    padding: 1.5rem;
}

@media (max-width: 768px) {
    .chat-container {
        height: 300px;
    }
    
    .message-bubble {
        max-width: 85%;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- En-tête de la course -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header trip-management-header text-center py-4">
                    <h2 class="h4 mb-2">
                        <i class="bi bi-car-front me-2"></i>
                        {% if is_chauffeur %}Gestion de Course{% else %}Suivi de Course{% endif %}
                    </h2>
                    <p class="mb-0 opacity-90">
                        Course #{{ trip.id }} - {{ trip.get_status_display }}
                    </p>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Colonne gauche: Informations de la course -->
        <div class="col-lg-4 mb-4">
            <!-- Statut de la course -->
            <div class="trip-status {{ trip.status }}">
                <div class="d-flex align-items-center mb-2">
                    {% if trip.status == 'in_progress' %}
                        <i class="bi bi-play-circle text-success me-2" style="font-size: 1.5rem;"></i>
                        <h5 class="mb-0 text-success">Course en cours</h5>
                    {% elif trip.status == 'scheduled' %}
                        <i class="bi bi-clock text-warning me-2" style="font-size: 1.5rem;"></i>
                        <h5 class="mb-0 text-warning">Course programmée</h5>
                    {% elif trip.status == 'completed' %}
                        <i class="bi bi-check-circle text-success me-2" style="font-size: 1.5rem;"></i>
                        <h5 class="mb-0 text-success">Course terminée</h5>
                    {% elif trip.status == 'archived' %}
                        <i class="bi bi-archive text-secondary me-2" style="font-size: 1.5rem;"></i>
                        <h5 class="mb-0 text-secondary">Course archivée</h5>
                    {% endif %}
                </div>
                <p class="mb-0 small">
                    {% if trip.started_at %}
                        Commencée à {{ trip.started_at|time:"H:i" }}
                    {% else %}
                        Programmée pour {{ pickup_time|time:"H:i" }}
                    {% endif %}
                </p>
                
                {% if trip.status == 'completed' %}
                <div class="mt-3">
                    <button class="btn btn-outline-secondary btn-sm" onclick="archiveTrip()">
                        <i class="bi bi-archive me-1"></i>
                        Archiver la course
                    </button>
                </div>
                {% endif %}
            </div>

            <!-- Informations du trajet -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-light">
                    <h6 class="mb-0">
                        <i class="bi bi-geo-alt me-2"></i>
                        Informations du trajet
                    </h6>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <div class="d-flex align-items-center mb-2">
                            <i class="bi bi-geo-alt text-primary me-2"></i>
                            <strong>Départ</strong>
                        </div>
                        <p class="ms-4 mb-0 text-muted">{{ pickup_location }}</p>
                    </div>
                    
                    <div class="mb-3">
                        <div class="d-flex align-items-center mb-2">
                            <i class="bi bi-flag text-success me-2"></i>
                            <strong>Destination</strong>
                        </div>
                        <p class="ms-4 mb-0 text-muted">{{ dropoff_location }}</p>
                    </div>
                    
                    <div>
                        <div class="d-flex align-items-center mb-2">
                            <i class="bi bi-clock text-info me-2"></i>
                            <strong>Heure prévue</strong>
                        </div>
                        <p class="ms-4 mb-0 text-muted">{{ pickup_time|time:"H:i" }}</p>
                    </div>
                </div>
            </div>

            <!-- Informations sur l'autre utilisateur (sans infos confidentielles) -->
            <div class="user-info-card">
                <div class="d-flex align-items-center mb-3">
                    {% if other_user.avatar %}
                        <img src="{{ other_user.avatar.url }}" alt="Avatar" class="user-avatar me-3">
                    {% else %}
                        <div class="user-avatar bg-secondary d-flex align-items-center justify-content-center me-3">
                            <i class="bi bi-person text-white"></i>
                        </div>
                    {% endif %}
                    <div>
                        <h6 class="mb-0">{{ other_user.name }}</h6>
                        <small class="text-muted">{{ other_user.role }}</small>
                    </div>
                </div>
                
                {% if not is_chauffeur and other_user.vehicle %}
                    <div class="mb-2">
                        <i class="bi bi-car-front me-2"></i>
                        <strong>Véhicule:</strong> {{ other_user.vehicle }}
                    </div>
                    <div class="mb-2">
                        <i class="bi bi-hash me-2"></i>
                        <strong>Plaque:</strong> {{ other_user.plate }}
                    </div>
                    <div>
                        <i class="bi bi-star-fill text-warning me-2"></i>
                        <strong>Note:</strong> {{ other_user.rating }}/5
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Colonne droite: Chat et mises à jour -->
        <div class="col-lg-8">
            {% if has_mobility_plus %}
            <!-- Chat (Mobility Plus uniquement) -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-light">
                    <div class="d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">
                            <i class="bi bi-chat-dots me-2"></i>
                            Chat avec {{ other_user.name }}
                        </h6>
                        <span class="badge bg-success">Mobility Plus</span>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="chat-container" id="chatContainer">
                        <!-- Messages chargés via JavaScript -->
                    </div>
                    <div class="p-3 border-top">
                        <form id="messageForm" class="d-flex gap-2">
                            <input type="text" class="form-control" id="messageInput" 
                                   placeholder="Tapez votre message..." maxlength="500">
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-send"></i>
                            </button>
                        </form>
                    </div>
                </div>
            </div>
            {% else %}
            <!-- Message pour Mobility Plus -->
            <div class="alert alert-info border-0 shadow-sm mb-4">
                <div class="d-flex align-items-center">
                    <i class="bi bi-info-circle me-3" style="font-size: 1.5rem;"></i>
                    <div>
                        <h6 class="alert-heading mb-1">Chat disponible avec Mobility Plus</h6>
                        <p class="mb-0">
                            Communiquez directement avec votre {{ is_chauffeur|yesno:"passager,chauffeur" }} 
                            en souscrivant à l'abonnement Mobility Plus.
                        </p>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Mises à jour de statut -->
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-light">
                    <div class="d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">
                            <i class="bi bi-activity me-2"></i>
                            Mises à jour de la course
                        </h6>
                        {% if is_chauffeur %}
                            <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#updateModal">
                                <i class="bi bi-plus-circle me-1"></i>
                                Ajouter une mise à jour
                            </button>
                        {% endif %}
                    </div>
                </div>
                <div class="card-body">
                    <div id="updatesContainer">
                        {% for update in updates %}
                            <div class="status-update">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <h6 class="mb-1">{{ update.get_update_type_display }}</h6>
                                        {% if update.message %}
                                            <p class="mb-1 text-muted">{{ update.message }}</p>
                                        {% endif %}
                                    </div>
                                    <small class="text-muted">{{ update.timestamp|time:"H:i" }}</small>
                                </div>
                            </div>
                        {% empty %}
                            <p class="text-muted text-center py-3">Aucune mise à jour pour le moment</p>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% if is_chauffeur %}
<!-- Modal pour ajouter une mise à jour -->
<div class="modal fade" id="updateModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Ajouter une mise à jour</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="updateForm">
                    <div class="mb-3">
                        <label for="updateType" class="form-label">Type de mise à jour</label>
                        <select class="form-select" id="updateType" required>
                            <option value="">Sélectionner</option>
                            <option value="started">Course commencée</option>
                            <option value="pickup">Arrivé au point de départ</option>
                            <option value="passenger_picked">Passager récupéré</option>
                            <option value="destination_reached">Arrivé à destination</option>
                            <option value="completed">Course terminée</option>
                            <option value="issue">Problème signalé</option>
                            <option value="delay">Retard signalé</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="updateMessage" class="form-label">Message (optionnel)</label>
                        <textarea class="form-control" id="updateMessage" rows="3" 
                                  placeholder="Ajoutez des détails si nécessaire..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-primary" onclick="sendUpdate()">
                    Envoyer la mise à jour
                </button>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
const tripId = {{ trip.id }};
let messagesInterval;

document.addEventListener('DOMContentLoaded', function() {
    {% if has_mobility_plus %}
        loadMessages();
        startMessagesPolling();
        
        // Gérer l'envoi de messages
        document.getElementById('messageForm').addEventListener('submit', function(e) {
            e.preventDefault();
            sendMessage();
        });
    {% endif %}
});

{% if has_mobility_plus %}
function loadMessages() {
    fetch(`/courses/api/trip/${tripId}/messages/`)
        .then(response => response.json())
        .then(data => {
            displayMessages(data.messages);
        })
        .catch(error => {
            console.error('Erreur chargement messages:', error);
        });
}

function displayMessages(messages) {
    const container = document.getElementById('chatContainer');
    
    container.innerHTML = messages.map(msg => `
        <div class="message ${msg.is_own ? 'own' : ''}">
            <div class="message-bubble">
                <div class="message-text">${msg.message}</div>
                <div class="message-time">${msg.timestamp}</div>
            </div>
        </div>
    `).join('');
    
    // Scroll vers le bas
    container.scrollTop = container.scrollHeight;
}

function sendMessage() {
    const input = document.getElementById('messageInput');
    const message = input.value.trim();
    
    if (!message) return;
    
    // Désactiver l'input pendant l'envoi
    input.disabled = true;
    
    const formData = new FormData();
    formData.append('message', message);
    
    fetch(`/courses/api/trip/${tripId}/send-message/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            input.value = '';
            loadMessages(); // Recharger les messages
        } else {
            alert('Erreur lors de l\'envoi: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Erreur envoi message:', error);
        alert('Erreur de connexion');
    })
    .finally(() => {
        input.disabled = false;
        input.focus();
    });
}

function startMessagesPolling() {
    // Polling toutes les 5 secondes
    messagesInterval = setInterval(loadMessages, 5000);
}

// Marquer les messages comme lus quand l'utilisateur ouvre la page
function markMessagesAsRead() {
    fetch(`/courses/api/trip/${tripId}/mark-messages-read/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log(`${data.marked_count} messages marqués comme lus`);
        }
    })
    .catch(error => {
        console.error('Erreur marquage messages:', error);
    });
}

// Appeler la fonction au chargement de la page
document.addEventListener('DOMContentLoaded', function() {
    markMessagesAsRead();
});
{% endif %}

{% if is_chauffeur %}
function sendUpdate() {
    const type = document.getElementById('updateType').value;
    const message = document.getElementById('updateMessage').value;
    
    if (!type) {
        alert('Veuillez sélectionner le type de mise à jour');
        return;
    }
    
    // Désactiver le bouton
    const btn = document.querySelector('[onclick="sendUpdate()"]');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Envoi...';
    
    const formData = new FormData();
    formData.append('update_type', type);
    formData.append('message', message);
    
    fetch(`/courses/api/trip/${tripId}/update-status/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Fermer le modal
            bootstrap.Modal.getInstance(document.getElementById('updateModal')).hide();
            
            // Recharger la page pour voir la mise à jour
            location.reload();
        } else {
            alert('Erreur: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Erreur:', error);
        alert('Erreur de connexion');
    })
    .finally(() => {
        btn.disabled = false;
        btn.innerHTML = 'Envoyer la mise à jour';
    });
}
{% endif %}

// Fonction pour archiver une course
function archiveTrip() {
    if (confirm('Êtes-vous sûr de vouloir archiver cette course ? Cette action est irréversible.')) {
        fetch(`/courses/api/trip/${tripId}/archive/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                location.reload();
            } else {
                alert('Erreur: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Erreur archivage:', error);
            alert('Erreur de connexion');
        });
    }
}

// Nettoyer les intervals avant de quitter
window.addEventListener('beforeunload', function() {
    if (messagesInterval) {
        clearInterval(messagesInterval);
    }
});
</script>
{% endblock %}


