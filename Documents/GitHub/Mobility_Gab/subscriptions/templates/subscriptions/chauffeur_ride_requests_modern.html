{% extends 'base.html' %}

{% block page_title %}Demandes de course en temps réel{% endblock %}

{% block extra_css %}
<style>
/* Header Banner - Orange glassmorphism fluide */
.hero-banner {
    position: relative;
    background: linear-gradient(135deg, #FF8C00 0%, #FFA500 50%, #FFB733 100%);
    border-radius: var(--radius-lg);
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    color: var(--white);
    box-shadow: 0 8px 32px rgba(255, 140, 0, 0.25);
    overflow: hidden;
}

/* Effet fluide transparent animé */
.hero-banner::before {
    content: '';
    position: absolute;
    top: -50%;
    right: -20%;
    width: 300px;
    height: 300px;
    background: radial-gradient(circle, rgba(255, 255, 255, 0.15) 0%, transparent 70%);
    border-radius: 50%;
    animation: float 8s ease-in-out infinite;
}

.hero-banner::after {
    content: '';
    position: absolute;
    bottom: -30%;
    left: -10%;
    width: 200px;
    height: 200px;
    background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
    border-radius: 50%;
    animation: float 6s ease-in-out infinite reverse;
}

@keyframes float {
    0%, 100% {
        transform: translate(0, 0) scale(1);
    }
    50% {
        transform: translate(-20px, -20px) scale(1.1);
    }
}

.hero-icon {
    width: 50px;
    height: 50px;
    border-radius: var(--radius-md);
    background: rgba(255, 255, 255, 0.25);
    backdrop-filter: blur(10px);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--white);
    font-size: 1.5rem;
    margin-right: 1rem;
    flex-shrink: 0;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    position: relative;
    z-index: 1;
}

.hero-banner h2 {
    color: var(--white);
    margin-bottom: 0.25rem;
    font-size: 1.5rem;
    font-weight: 700;
    text-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    position: relative;
    z-index: 1;
}

.hero-banner .text-muted {
    color: rgba(255, 255, 255, 0.9) !important;
    text-shadow: 0 1px 4px rgba(0, 0, 0, 0.1);
    position: relative;
    z-index: 1;
}

/* Onglets modernes */
.nav-tabs {
    border-bottom: 2px solid var(--gray-200);
    margin-bottom: 1.5rem;
}

.nav-tabs .nav-link {
    border: none;
    color: var(--gray-600);
    font-weight: 600;
    padding: 0.875rem 1.5rem;
    border-bottom: 3px solid transparent;
    transition: all var(--transition-fast);
}

.nav-tabs .nav-link:hover {
    color: var(--primary);
    border-bottom-color: var(--primary-light);
}

.nav-tabs .nav-link.active {
    color: var(--primary);
    background: transparent;
    border-bottom-color: var(--primary);
}

/* Cards optimisées */
.request-card {
    border: none;
    border-radius: var(--radius-lg);
    background: var(--white);
    box-shadow: var(--shadow-md);
    transition: all var(--transition-base);
    height: 100%;
}

.request-card:hover {
    transform: translateY(-4px);
    box-shadow: var(--shadow-xl);
}

.request-card.border-warning {
    border-left: 4px solid var(--warning) !important;
}

/* Meta grid responsive */
.request-meta {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap: 0.75rem;
    background: var(--gray-100);
    border-radius: var(--radius-md);
    padding: 1rem;
    margin: 1rem 0;
}

.request-meta .meta-item {
    display: flex;
    align-items: flex-start;
    gap: 0.5rem;
    font-size: 0.875rem;
    color: var(--gray-700);
}

.request-meta .meta-item i {
    font-size: 1.125rem;
    color: var(--primary);
    flex-shrink: 0;
    margin-top: 0.125rem;
}

.request-meta .meta-item strong {
    display: block;
    font-size: 0.75rem;
    color: var(--gray-500);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: 0.125rem;
}

/* Badges */
.badge-pill {
    border-radius: var(--radius-full);
    padding: 0.375rem 0.875rem;
    font-size: 0.75rem;
    font-weight: 600;
}

/* Empty state */
.empty-state {
    border-radius: var(--radius-lg);
    border: 2px dashed var(--gray-300);
    padding: 3rem 2rem;
    background: var(--gray-100);
    text-align: center;
}

.empty-state i {
    font-size: 3rem;
    color: var(--primary);
    opacity: 0.5;
}

.empty-state h4 {
    margin-top: 1rem;
    color: var(--gray-700);
}

/* Buttons groupes */
.btn-group {
    display: flex;
    gap: 0.5rem;
}

.btn-group .btn {
    border-radius: var(--radius-md);
    font-weight: 600;
    padding: 0.625rem 1.25rem;
    font-size: 0.875rem;
}

/* Responsive Mobile */
@media (max-width: 767px) {
    /* Hero banner compact */
    .hero-banner {
        padding: 1rem;
        margin-bottom: 1rem;
    }
    
    .hero-banner .d-flex {
        flex-direction: column !important;
        align-items: flex-start !important;
        gap: 1rem;
    }
    
    .hero-icon {
        width: 40px;
        height: 40px;
        font-size: 1.25rem;
    }
    
    .hero-banner h2 {
        font-size: 1.25rem;
    }
    
    .hero-banner .text-end {
        text-align: left !important;
        width: 100%;
    }
    
    /* Onglets responsive */
    .nav-tabs .nav-link {
        padding: 0.75rem 1rem;
        font-size: 0.875rem;
    }
    
    .nav-tabs .nav-link i {
        font-size: 1rem;
    }
    
    /* Cards pleine largeur */
    .col-xl-6 {
        width: 100%;
    }
    
    .request-card {
        margin-bottom: 1rem;
    }
    
    .request-card .card-body {
        padding: 1rem !important;
    }
    
    /* Meta grid 1 colonne sur mobile */
    .request-meta {
        grid-template-columns: 1fr;
        gap: 0.5rem;
        padding: 0.75rem;
    }
    
    .request-meta .meta-item {
        font-size: 0.8125rem;
    }
    
    /* Boutons empilés */
    .request-card .btn-group {
        flex-direction: column;
        width: 100%;
    }
    
    .request-card .btn {
        width: 100%;
        padding: 0.75rem;
        font-size: 0.875rem;
    }
    
    /* Titres cards */
    .request-card h4 {
        font-size: 1.125rem;
    }
    
    /* Justification responsive */
    .request-card .d-flex.justify-content-between {
        flex-direction: column;
        align-items: flex-start !important;
        gap: 1rem;
    }
    
    .request-card .d-flex.justify-content-between:last-child {
        margin-top: 1rem;
    }
    
    /* Empty state compact */
    .empty-state {
        padding: 2rem 1rem;
    }
    
    .empty-state i {
        font-size: 2.5rem;
    }
    
    .empty-state h4 {
        font-size: 1.125rem;
    }
}

/* Responsive Tablet */
@media (min-width: 768px) and (max-width: 1199px) {
    .request-meta {
        grid-template-columns: repeat(2, 1fr);
    }
}

/* Container optimization */
.container-fluid {
    max-width: 1400px;
    margin: 0 auto;
    padding: 0 1rem;
}

@media (min-width: 1200px) {
    .container-fluid {
        padding: 0 2rem;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Hero Banner Compact -->
    <div class="hero-banner d-flex align-items-center justify-content-between">
        <div class="d-flex align-items-center">
            <div class="hero-icon">
                <i class="bi bi-bell-fill"></i>
            </div>
            <div>
                <h2>Demandes temps réel</h2>
                <p class="text-muted mb-0">Gérez vos demandes en direct</p>
            </div>
        </div>
        <div class="text-end">
            <span class="badge badge-pill" style="background: rgba(255, 255, 255, 0.25); color: white;">
                <i class="bi bi-activity me-1"></i>
                <span id="totalCount">0</span> total
            </span>
            <p class="text-muted small mb-0 mt-1">Actualisation auto • 20s</p>
        </div>
    </div>

    <!-- Onglets -->
    <ul class="nav nav-tabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="rides-tab" data-bs-toggle="tab" data-bs-target="#rides-pane" type="button" role="tab">
                <i class="bi bi-car-front me-1"></i>
                Courses
                <span id="ridesCount" class="badge bg-primary rounded-pill ms-2">0</span>
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="subscriptions-tab" data-bs-toggle="tab" data-bs-target="#subscriptions-pane" type="button" role="tab">
                <i class="bi bi-calendar-check me-1"></i>
                Abonnements
                <span id="subscriptionsCount" class="badge bg-warning rounded-pill ms-2">0</span>
            </button>
        </li>
    </ul>

    <!-- Contenu -->
    <div class="tab-content">
        <div class="tab-pane fade show active" id="rides-pane" role="tabpanel">
            <div id="ridesContainer" class="row g-3"></div>
        </div>
        <div class="tab-pane fade" id="subscriptions-pane" role="tabpanel">
            <div id="subscriptionsContainer" class="row g-3"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const ridesContainer = document.getElementById('ridesContainer');
const subscriptionsContainer = document.getElementById('subscriptionsContainer');
const ridesCountBadge = document.getElementById('ridesCount');
const subscriptionsCountBadge = document.getElementById('subscriptionsCount');
const totalCountBadge = document.getElementById('totalCount');

function fetchAllRequests() {
    // Récupérer les demandes de course
    fetch('{% url "subscriptions:ride_requests_realtime" %}')
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                console.error(data.error);
                return;
            }
            ridesCountBadge.textContent = data.requests.length;
            renderRideRequests(data.requests);
            updateTotalCount();
        })
        .catch(error => console.error('Erreur polling courses', error));
    
    // Récupérer les demandes d'abonnement
    fetch('{% url "subscriptions:subscription_requests_realtime" %}')
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                console.error(data.error);
                return;
            }
            subscriptionsCountBadge.textContent = data.requests.length;
            renderSubscriptionRequests(data.requests);
            updateTotalCount();
        })
        .catch(error => console.error('Erreur polling abonnements', error));
}

function updateTotalCount() {
    const ridesCount = parseInt(ridesCountBadge.textContent) || 0;
    const subsCount = parseInt(subscriptionsCountBadge.textContent) || 0;
    totalCountBadge.textContent = ridesCount + subsCount;
}

function renderRideRequests(requests) {
    ridesContainer.innerHTML = '';
    if (!requests.length) {
        ridesContainer.innerHTML = `
            <div class="col-12">
                <div class="empty-state">
                    <i class="bi bi-calendar-heart"></i>
                    <h4 class="mt-3 mb-2">Aucune demande de course pour le moment</h4>
                    <p class="text-muted mb-0">Restez disponible pour recevoir les prochaines demandes de course.</p>
                </div>
            </div>`;
        return;
    }
    
    requests.forEach(request => {
        const card = document.createElement('div');
        card.className = 'col-xl-6';
        card.innerHTML = `
            <div class="card request-card">
                <div class="card-body p-4">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h4 class="mb-1">${request.parent_name}</h4>
                            <p class="text-muted small mb-0">Demande reçue il y a ${request.created_ago} min</p>
                        </div>
                        <span class="badge bg-primary-subtle text-primary-emphasis badge-pill">
                            ${request.distance_km ? `${request.distance_km} km` : 'Distance inconnue'}
                        </span>
                    </div>

                    <div class="request-meta">
                        <div class="meta-item">
                            <i class="bi bi-geo-alt"></i>
                            <div>
                                <strong>Départ</strong><br>${request.pickup_location}
                            </div>
                        </div>
                        <div class="meta-item">
                            <i class="bi bi-flag"></i>
                            <div>
                                <strong>Destination</strong><br>${request.dropoff_location}
                </div>
                        </div>
                        <div class="meta-item">
                            <i class="bi bi-clock-history"></i>
                            <div>
                                <strong>Heure</strong><br>${request.pickup_time}
                    </div>
                        </div>
                        <div class="meta-item">
                            <i class="bi bi-chat-dots"></i>
                            <div>
                                <strong>Notes</strong><br>${request.notes || 'Aucune indication'}
                    </div>
                        </div>
                    </div>
                    
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="text-muted small">
                            <i class="bi bi-lightning-charge text-warning"></i>
                            Décidez rapidement pour répondre au particulier.
                        </div>
                        <div class="btn-group">
                            <button class="btn btn-outline-danger" onclick="respondRequest('${request.decline_url}', false)">
                                <i class="bi bi-x-lg me-1"></i> Refuser
                        </button>
                            <button class="btn btn-success" onclick="respondRequest('${request.accept_url}', true)">
                                <i class="bi bi-check-lg me-1"></i> Accepter
                        </button>
                        </div>
                    </div>
                </div>
            </div>`;
        ridesContainer.appendChild(card);
    });
}

function renderSubscriptionRequests(requests) {
    subscriptionsContainer.innerHTML = '';
    if (!requests.length) {
        subscriptionsContainer.innerHTML = `
            <div class="col-12">
                <div class="empty-state">
                    <i class="bi bi-calendar-check"></i>
                    <h4 class="mt-3 mb-2">Aucune demande d'abonnement pour le moment</h4>
                    <p class="text-muted mb-0">Les demandes d'abonnement mensuelles apparaîtront ici.</p>
                </div>
            </div>`;
        return;
    }
    
    requests.forEach(request => {
        const card = document.createElement('div');
        card.className = 'col-xl-6';
        const returnTimeText = request.return_time ? `<br>Retour: ${request.return_time}` : '';
        const childNameText = request.child_name ? `<br>Enfant: ${request.child_name}` : '';
        
        card.innerHTML = `
            <div class="card request-card border-warning">
                <div class="card-body p-4">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <div>
                            <h4 class="mb-1"><i class="bi bi-calendar-check text-warning me-2"></i>${request.title}</h4>
                            <p class="text-muted small mb-0">
                                <i class="bi bi-person"></i> ${request.parent_name} • 
                                <i class="bi bi-clock"></i> Il y a ${request.created_ago} min
                            </p>
                        </div>
                        <span class="badge bg-warning-subtle text-warning-emphasis badge-pill">
                            ${request.frequency}
                        </span>
                    </div>

                    <p class="text-muted mb-3">${request.description}</p>

                    <div class="request-meta">
                        <div class="meta-item">
                            <i class="bi bi-geo-alt"></i>
                            <div>
                                <strong>Départ</strong><br>${request.pickup_location}
                            </div>
                        </div>
                        <div class="meta-item">
                            <i class="bi bi-flag"></i>
                            <div>
                                <strong>Destination</strong><br>${request.dropoff_location}
                            </div>
                        </div>
                        <div class="meta-item">
                            <i class="bi bi-clock"></i>
                            <div>
                                <strong>Horaires</strong><br>
                                Départ: ${request.pickup_time}${returnTimeText}
                            </div>
                        </div>
                        <div class="meta-item">
                            <i class="bi bi-currency-dollar"></i>
                            <div>
                                <strong>Prix proposé</strong><br>
                                ${request.proposed_price.toLocaleString('fr-FR')} FCFA/mois
                            </div>
                        </div>
                    </div>
                    
                    ${request.special_requirements ? `
                        <div class="alert alert-info mt-3 mb-3 py-2">
                            <small><strong><i class="bi bi-info-circle me-1"></i>Exigences:</strong> ${request.special_requirements}${childNameText}</small>
                        </div>
                    ` : ''}
                    
                    <div class="d-flex justify-content-between align-items-center mt-3">
                        <div class="text-muted small">
                            <i class="bi bi-lightning-charge text-warning"></i>
                            Abonnement mensuel récurrent
                        </div>
                        <div class="btn-group">
                            <button class="btn btn-outline-danger btn-sm" onclick="respondSubscriptionRequest('${request.reject_url}', ${request.id})">
                                <i class="bi bi-x-lg me-1"></i> Refuser
                            </button>
                            <button class="btn btn-success btn-sm" onclick="respondSubscriptionRequest('${request.accept_url}', ${request.id})">
                                <i class="bi bi-check-lg me-1"></i> Accepter
                            </button>
                        </div>
                    </div>
                </div>
            </div>`;
        subscriptionsContainer.appendChild(card);
    });
}

function respondRequest(url, accepted) {
    fetch(url, {
        method: 'POST',
        headers: {'X-CSRFToken': '{{ csrf_token }}'}
    })
    .then(response => response.json())
    .then(data => {
        if (data.success !== false) {
            if (accepted) {
                // Rediriger vers la page des courses actives après acceptation
                window.location.href = '/courses/actives/';
            } else {
                // Rafraîchir la liste après refus
                fetchAllRequests();
            }
        } else {
            alert(data.error || 'Action impossible.');
        }
    })
    .catch(() => alert('Erreur réseau.'));
}

function respondSubscriptionRequest(url, requestId) {
    // Déterminer si c'est une acceptation ou un refus
    const isAccept = url.includes('/accept/');
    
    fetch(url, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/x-www-form-urlencoded'
        },
        body: 'response_message='
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            if (isAccept) {
                // Rediriger vers la page de gestion des abonnés après acceptation
                window.location.href = '/subscriptions/manage-subscribers/';
            } else {
                // Rafraîchir la liste après refus
                alert(data.message || 'Demande refusée');
                fetchAllRequests();
            }
        } else {
            alert(data.error || 'Action impossible.');
        }
    })
    .catch(() => alert('Erreur réseau.'));
}

// Initialiser
fetchAllRequests();
setInterval(fetchAllRequests, 20000);
</script>
{% endblock %}
