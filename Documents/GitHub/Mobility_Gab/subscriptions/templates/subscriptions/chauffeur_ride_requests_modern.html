{% extends 'base.html' %}

{% block page_title %}Demandes de course en temps réel{% endblock %}

{% block extra_css %}
<style>
.hero-banner {
    background: linear-gradient(135deg, rgba(15, 74, 166, 0.1), rgba(27, 187, 138, 0.1));
    border-radius: 1.25rem;
    padding: 2.25rem;
    border: 1px solid rgba(15, 74, 166, 0.08);
}
.hero-icon {
    width: 70px;
    height: 70px;
    border-radius: 20px;
    background: linear-gradient(135deg, var(--mg-primary), #0f4aa6);
    display: flex;
    align-items: center;
    justify-content: center;
    color: #fff;
    font-size: 2rem;
    margin-right: 1.5rem;
}
.request-card {
    border: none;
    border-radius: 1.25rem;
    background: #fff;
    box-shadow: 0 25px 60px -35px rgba(33, 37, 41, 0.4);
    transition: transform 0.25s ease, box-shadow 0.3s ease;
}
.request-card:hover {
    transform: translateY(-6px);
    box-shadow: 0 35px 70px -45px rgba(15, 74, 166, 0.45);
}
.request-meta {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 1rem;
    background: #f8fbff;
    border-radius: 1rem;
    padding: 1rem;
    margin: 1.25rem 0;
}
.request-meta .meta-item {
    display: flex;
    align-items: center;
    font-size: 0.9rem;
    color: #345;
}
.request-meta .meta-item i {
    font-size: 1rem;
    margin-right: 0.6rem;
    color: var(--mg-primary);
}
.badge-pill {
    border-radius: 999px;
    padding: 0.35rem 0.85rem;
    font-size: 0.75rem;
}
.empty-state {
    border-radius: 1.25rem;
    border: 1px dashed rgba(15, 74, 166, 0.25);
    padding: 3rem;
    background: rgba(248, 250, 255, 0.85);
    text-align: center;
}
.empty-state i {
    font-size: 3.2rem;
    color: var(--mg-primary);
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="hero-banner mb-4 d-flex align-items-center justify-content-between">
        <div class="d-flex align-items-center">
            <div class="hero-icon">
                        <i class="bi bi-bell-fill"></i>
            </div>
            <div>
                <h2 class="h4 mb-1">Demandes de course</h2>
                <p class="text-muted mb-0">Recevez, examinez et acceptez les demandes des particuliers.</p>
            </div>
        </div>
        <div class="text-end">
            <span class="badge bg-primary-subtle text-primary-emphasis badge-pill">
                <i class="bi bi-activity me-1"></i>
                <span id="requestsCount">0</span> demande(s)
            </span>
            <p class="text-muted small mb-0">Actualisation automatique toutes les 20 secondes.</p>
        </div>
    </div>

    <div id="requestsContainer" class="row g-4"></div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const container = document.getElementById('requestsContainer');
const countBadge = document.getElementById('requestsCount');

function fetchRequests() {
    fetch('{% url "subscriptions:ride_requests_realtime" %}')
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                console.error(data.error);
                return;
            }
            countBadge.textContent = data.requests.length;
            renderRequests(data.requests);
        })
        .catch(error => console.error('Erreur polling', error));
}

function renderRequests(requests) {
    container.innerHTML = '';
    if (!requests.length) {
        container.innerHTML = `
            <div class="col-12">
                <div class="empty-state">
                    <i class="bi bi-calendar-heart"></i>
                    <h4 class="mt-3 mb-2">Aucune demande pour le moment</h4>
                    <p class="text-muted mb-0">Restez disponible pour recevoir les prochaines sollicitations.</p>
                </div>
            </div>`;
        return;
    }
    
    requests.forEach(request => {
        const card = document.createElement('div');
        card.className = 'col-xl-6';
        card.innerHTML = `
            <div class="card request-card">
                <div class="card-body p-4">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h4 class="mb-1">${request.parent_name}</h4>
                            <p class="text-muted small mb-0">Demande reçue il y a ${request.created_ago} min</p>
                        </div>
                        <span class="badge bg-primary-subtle text-primary-emphasis badge-pill">
                            ${request.distance_km ? `${request.distance_km} km` : 'Distance inconnue'}
                        </span>
                    </div>

                    <div class="request-meta">
                        <div class="meta-item">
                            <i class="bi bi-geo-alt"></i>
                            <div>
                                <strong>Départ</strong><br>${request.pickup_location}
                            </div>
                        </div>
                        <div class="meta-item">
                            <i class="bi bi-flag"></i>
                            <div>
                                <strong>Destination</strong><br>${request.dropoff_location}
                </div>
                        </div>
                        <div class="meta-item">
                            <i class="bi bi-clock-history"></i>
                            <div>
                                <strong>Heure</strong><br>${request.pickup_time}
                    </div>
                        </div>
                        <div class="meta-item">
                            <i class="bi bi-chat-dots"></i>
                            <div>
                                <strong>Notes</strong><br>${request.notes || 'Aucune indication'}
                    </div>
                        </div>
                    </div>
                    
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="text-muted small">
                            <i class="bi bi-lightning-charge text-warning"></i>
                            Décidez rapidement pour répondre au particulier.
                        </div>
                        <div class="btn-group">
                            <button class="btn btn-outline-danger" onclick="respondRequest('${request.decline_url}', false)">
                                <i class="bi bi-x-lg me-1"></i> Refuser
                        </button>
                            <button class="btn btn-success" onclick="respondRequest('${request.accept_url}', true)">
                                <i class="bi bi-check-lg me-1"></i> Accepter
                        </button>
                        </div>
                    </div>
                </div>
            </div>`;
        container.appendChild(card);
    });
}

function respondRequest(url, accepted) {
    fetch(url, {
        method: 'POST',
        headers: {'X-CSRFToken': '{{ csrf_token }}'}
    })
    .then(response => response.json())
    .then(data => {
        if (data.success !== false) {
            fetchRequests();
        } else {
            alert(data.error || 'Action impossible.');
        }
    })
    .catch(() => alert('Erreur réseau.'));
}

fetchRequests();
setInterval(fetchRequests, 20000);
</script>
{% endblock %}
